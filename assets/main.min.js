firebase.initializeApp({apiKey:"AIzaSyDzKCN-wjRWLk7ojLlvqgWxi6jfC9e99Wc",authDomain:"movies-4348d.firebaseapp.com",projectId:"movies-4348d"});var db=firebase.firestore(),lastUpdateRef=db.collection("lastUpdated").doc("lastUpdated"),moviesRef=db.collection("movies"),movies=new Vue({el:"#movies",data:()=>({movieData:null,loading:!0,errored:!1,movieCount:0,activeCard:null,highlight:null,user:{id:null,email:null,password:null,name:null,authenticated:!1,errorMsg:!1},lazy:{busy:!1,totalShown:0,scrollIncrement:30},filter:{active:null,panelActive:!1,sort:"recent",search:"",format:[],rating:[],genre:[],startYear:null,endYear:null,randomMovie:!1},filterData:{digital:[],physical:[],genres:[],ratings:[],minYear:0,maxYear:0},request:{formActive:!1,title:null,status:null}}),computed:{movies(){var self=this,filteredMovies=_.filter(self.movieData,movie=>{var search=!self.filter.search||new RegExp("\\b"+self.filter.search,"gi").test(movie.title),format=!self.filter.format.length||(self.filter.format.includes(movie.vudu)||self.filter.format.includes(movie.googlePlay)||self.filter.format.includes(movie.itunes)||self.filter.format.includes(movie.plex)||self.filter.format.includes(movie.disc)),rating=!self.filter.rating.length||self.filter.rating.includes(movie.rating),genre=!self.filter.genre.length||self.filter.genre.every(item=>movie.genre.includes(item)),year=(self.filter.startYear?movie.year>=self.filter.startYear:self.filterData.minYear)&&(self.filter.endYear?movie.year<=self.filter.endYear:self.filterData.maxYear);return search&&format&&rating&&genre&&year});self.movieCount=filteredMovies.length,self.activeCard=null;var randomNum=_.random(filteredMovies.length-1);return self.filter.randomMovie&&randomNum>-1?(self.movieCount=1,[filteredMovies[randomNum]]):"alpha"==self.filter.sort?_.take(_.orderBy(filteredMovies,["title"],["asc"]),self.lazy.totalShown):_.take(_.orderBy(filteredMovies,m=>m.dateAcquired,["desc"]),self.lazy.totalShown)},isFiltering(){return this.filter.format.length>0||this.filter.genre.length>0||this.filter.rating.length>0||this.filter.startYear||this.filter.endYear},canReset(){return this.filter.randomMovie||this.filter.search||this.filter.format.length>0||this.filter.genre.length>0||this.filter.rating.length>0||this.filter.startYear||this.filter.endYear}},mounted(){var vm=this;lastUpdateRef.get().then(doc=>{var localUpdated=new Date(localStorage.getItem("lastUpdated")).toISOString(),remoteUpdated=doc.data().date.toDate().toISOString();localUpdated==remoteUpdated?vm.getLocalData():vm.getRemoteData(remoteUpdated)}).catch(error=>{console.log("Could not get lastUpdated.")}),firebase.auth().onAuthStateChanged(user=>{user?(vm.user.authenticated=!0,vm.user.id=user.uid,vm.user.name=user.displayName,vm.user.errorMsg=null):(vm.user.authenticated=!1,vm.user.id=null,vm.user.name=null)})},methods:{getRemoteData(remoteUpdated){var vm=this;moviesRef.get().then(querySnapshot=>{vm.movieData=querySnapshot.docs.map(doc=>({id:doc.id,...doc.data()})),vm.movieData.forEach(movie=>{if(movie.dateAcquired=movie.dateAcquired.toDate(),movie.length){var hours=Math.floor(movie.length/60)+"h ",minutes=movie.length%60+"m";movie.length=hours+minutes}movie.genre=_.sortBy(movie.genre)}),vm.setLocalData(remoteUpdated)}).catch(error=>{console.log(error),vm.errored=!0})},getLocalData(){var vm=this,localData=localStorage.getItem("movieData");vm.movieData=JSON.parse(localData),vm.initFilters()},setLocalData(remoteUpdated){var vm=this;localStorage.clear(),localStorage.setItem("movieData",JSON.stringify(vm.movieData)),localStorage.setItem("lastUpdated",remoteUpdated),vm.initFilters()},initFilters(){var vm=this;vm.filterData.genres=[...new Set(vm.movieData.flatMap(movie=>movie.genre))].sort(),vm.filterData.minYear=_.min(vm.movieData.flatMap(movie=>movie.year)),vm.filterData.maxYear=_.max(vm.movieData.flatMap(movie=>movie.year));var vuduFormats,gpFormats,itunesFormats,plexFormats,mergedFormats=[...vm.movieData.flatMap(movie=>movie.vudu),...vm.movieData.flatMap(movie=>movie.googlePlay),...vm.movieData.flatMap(movie=>movie.itunes),...vm.movieData.flatMap(movie=>movie.plex)];vm.filterData.digital=[...new Set(mergedFormats)].filter(el=>el&&""!=el).sort();var discFormats=vm.movieData.flatMap(movie=>movie.disc);vm.filterData.physical=[...new Set(discFormats)].filter(el=>el&&""!=el).sort();for(var ratings=[...new Set(vm.movieData.flatMap(movie=>movie.rating))],ratingsOrder=["G","TV-G","PG","TV-PG","PG-13","TV-14","R","TV-MA","NC-17","NR"],orderedRatings=[],i=0;i<ratingsOrder.length;i++)ratings.indexOf(ratingsOrder[i])>-1&&orderedRatings.push(ratingsOrder[i]);vm.filterData.ratings=orderedRatings,vm.loading=!1},loadMore(){this.lazy.busy=!0,this.lazy.totalShown+=this.lazy.scrollIncrement,this.lazy.busy=!1},openModal(index){this.activeCard=index.toString(),this.filter.active=null,this.filter.panelActive=!1,this.$nextTick(()=>{this.$refs.modalCard.focus(),this.$refs.modalCardOverlay.scrollTop=0})},closeModal(){this.$refs.movieCard[this.activeCard].focus(),this.activeCard=null},toggleFilters(){this.filter.panelActive=!this.filter.panelActive,this.filter.panelActive&&(this.activeCard=null)},selectFilter(filter){filter===this.filter.active?this.filter.active=null:this.filter.active=filter,this.activeCard=null},closeFilter(){this.filter.active=null},validateMinYear(){this.filter.startYear&&this.filter.startYear<this.filterData.minYear&&(this.filter.startYear=this.filterData.minYear),this.filter.startYear&&this.filter.startYear>this.filterData.maxYear&&(this.filter.startYear=this.filterData.maxYear)},validateMaxYear(){this.filter.endYear&&this.filter.endYear<this.filterData.minYear&&(this.filter.endYear=this.filterData.minYear),this.filter.endYear&&this.filter.endYear>this.filterData.maxYear&&(this.filter.endYear=this.filterData.maxYear)},selectRandom(){this.filter.randomMovie=!1,this.filter.randomMovie=!0,this.filter.panelActive=!1,this.filter.active=null},highlightEl(el){var self=this;self.highlight=el,setTimeout((function(){self.highlight=null}),300)},toggleRequestForm(e){this.request.formActive=!this.request.formActive,e.target.blur(),this.request.formActive&&(this.user.authenticated?this.$refs.requestTitle.focus():this.$refs.userEmail.focus())},signIn(){var vm=this;firebase.auth().signInWithEmailAndPassword(vm.user.email,vm.user.password).catch(error=>{vm.user.errorMsg=!0})},submitRequest(){var scriptURL="https://script.google.com/macros/s/AKfycbzDLlzElZKNrEPIcrnQNV9P6duLdkufuq_g8QQSSTgi0yHvU3Y/exec",formData=new FormData;formData.append("Movie Title",this.request.title),formData.append("Requester",this.user.name),this.request.status="processing",fetch(scriptURL,{method:"POST",body:formData}).then(result=>{this.request.status="success",this.request.title=null}).catch(error=>{console.error(error.message),this.request.status="error"})},reset(){var self=this;self.activeCard=null,self.filter.search="",self.filter.format=[],self.filter.rating=[],self.filter.genre=[],self.filter.startYear=null,self.filter.endYear=null,setTimeout((function(){self.filter.randomMovie=!1}),250)},documentClick(e){}},created(){},destroyed(){}});